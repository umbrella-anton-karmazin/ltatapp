# TASKS

Created 2025-02-28.

- [x] Черновой HLD и обзор архитектуры (2025-02-28) — зафиксировано в PLAN.md.
- [x] Уточнить пороги подсчета активности и таймаут простоя со стейкхолдерами.
- [x] Определить минимальное разрешение/формат скриншотов и ограничения по хранению (2025-02-28) — дефолт 1280px по ширине, JPEG/HEIC; хранить до подтвержденного синка, пока нет синка — 7 дней.
- [x] Подтвердить выбор десктопного стека (нативный Swift/SwiftUI + helper) или альтернативы (2025-02-28) — принято Swift/SwiftUI + AppKit (при необходимости), helper через LaunchAgent/XPC.
- [x] Оценить реализуемость и политику приватности для сигналов аудио/камеры (2025-02-28) — принято: не делать в MVP.
- [x] Сформировать MVP-бэклог и порядок работ для Mac (трекинг, захват, отчеты, заглушка синка) (2025-02-28) — зафиксировано в PLAN.md (Update 2025-02-28: MVP-бэклог).
- [x] Задокументировать конфигурационный файл (JSON/YAML): квант, partial, активность (K_MAX/веса/пороги), категории приложений, пороги аномалий, параметры скриншотов, retention (future) (2025-02-28) — зафиксировано в PLAN.md (Update 2025-02-28: Конфиг...).
- [x] Специфицировать схему данных: Project, Task, Quantum (partial/too_short, actualDurationSeconds), ActivityAggregate, FocusAggregate, ScreenshotMetadata; предусмотреть флаг `enableRawEvents` (2025-02-28) — зафиксировано в PLAN.md (Update 2025-02-28: Конфиг...).
- [x] Определить контракт `AIReportAnalyzer.analyze` (payload входа/выхода), формат mock-ответа и логирование без скриншотов (2025-02-28) — описано в PLAN.md (Update 2025-02-28: Конфиг...).
- [x] Описать структуру HTML-отчета: метрики дня, график активности, топ приложений, переключения, таймлайн квантов со скриншотами, аномалии (2025-02-28) — описано в PLAN.md.
- [x] Проработать UX-флоу MVP: онбординг/permissions, главный экран (статус, проект/задача, Start/Stop), Today view, превью отчета, настройки; учесть авто-паузу/возврат (2025-02-28) — описано в PLAN.md.
- [x] Предложить дефолтные пороги/веса для активности и минимальную длительность partial-кванта (drop vs `too_short`) (2025-02-28) — K_MAX=150, C_MAX=90, S_MAX=120, M_MAX=5000px, веса 0.4/0.25/0.2/0.15, low activity <20%; partial: <30s drop, 30–120s `too_short`, ≥120s normal partial.
- [x] Составить базовый список bundleId → category для популярных браузеров, IDE, офисных пакетов, мессенджеров и т.д. (2025-02-28) — зафиксировано в PLAN.md (Update 2025-02-28).
- [x] Реализовать загрузку конфига (JSON/YAML), базовый UI-шелл, логирование/аудит, структуру БД/миграции — scaffolding добавлен (SwiftPM app, ConfigLoader, logger, schema, SwiftUI shell); сборка проходит (2025-12-16).
  - [x] Починить входную точку SwiftUI: конфликт `main.swift` и `@main` (2025-12-16) — переименован `mac-app/Sources/LTATApp/main.swift` → `mac-app/Sources/LTATApp/LTATApp.swift`, чтобы убрать special-case `main.swift`.
  - [x] Починить `Codable` для `AuditEvent`/`LogLevel` (2025-12-16) — `LogLevel` теперь `Codable`, автосинтез `AuditEvent: Codable` снова работает.
  - [x] Починить ошибки Swift 6 Concurrency для `AppLogger.shared` / `@Sendable` closure (2025-12-16) — добавлены `Sendable`/`@unchecked Sendable` и синхронизация состояния логгера через его очередь.
  - [x] Починить YAML-декодинг: у `Yams.YAMLDecoder` нет `keyDecodingStrategy` (нужен snake_case маппинг) (2025-12-16) — YAML теперь парсится через `Yams.load` → JSON → `JSONDecoder.convertFromSnakeCase`.
  - [x] Прогнать `swift build` и зафиксировать статус (2025-12-16) — `swift build` проходит на Swift 6.2.3.
- [x] Реализовать permissions/onboarding (Screen Recording, Accessibility, Input Monitoring), обработку отказов и установку LaunchAgent — completed 2025-12-16: onboarding + gating + LaunchAgent (UI/CLI); подтверждено пользователем.
  - [x] Определить список разрешений и критерии “готово для трекинга” (2025-12-16) — критерий: Screen Recording + Accessibility + Input Monitoring = granted (`mac-app/Sources/LTATApp/Permissions.swift`).
  - [x] Реализовать `PermissionStatus`/проверки для Screen Recording / Accessibility / Input Monitoring (2025-12-16) — `PermissionsManager.refresh()` (`mac-app/Sources/LTATApp/Permissions.swift`).
  - [x] Реализовать механизм “запросить/подсказать”: `CGRequestScreenCaptureAccess`, `AXIsProcessTrustedWithOptions`, инструкции для Input Monitoring (2025-12-16) — добавлены request/open settings методы (`mac-app/Sources/LTATApp/Permissions.swift`, `mac-app/Sources/LTATApp/OnboardingView.swift`).
  - [x] Добавить экран/флоу онбординга в SwiftUI (пошагово, кнопки “Open System Settings”, статус-лейблы) (2025-12-16) — `OnboardingView` (`mac-app/Sources/LTATApp/OnboardingView.swift`).
  - [x] Заблокировать `Start` и показать онбординг, пока нет нужных разрешений (2025-12-16) — `ContentView` показывает onboarding, пока `isReadyForTracking == false` (`mac-app/Sources/LTATApp/ContentView.swift`).
  - [x] Добавить polling/обновление статусов после возврата из System Settings (2025-12-16) — refresh на `NSApplication.didBecomeActiveNotification` + manual refresh (`mac-app/Sources/LTATApp/OnboardingView.swift`).
  - [x] Определиться с форматом helper-а и LaunchAgent (отдельный бинарь vs режим в основном приложении) (2025-12-16) — принято: вариант A (один бинарь с `--helper`), зафиксировано в DECISIONS.md (2025-12-16).
  - [x] Реализовать установку/удаление LaunchAgent (plist в `~/Library/LaunchAgents`, enable/disable) (2025-12-16) — добавлен `LaunchAgentManager` + CLI флаги `--install-launchagent/--uninstall-launchagent` и UI-кнопки.
  - [x] Прогнать сборку и smoke: запуск, проверка переходов, логирование отказов (2025-12-16) — `swift build` и `swift run LTATApp -- --helper --once` ок; UI/permissions проверены вручную (подтверждено пользователем).
- [x] Реализовать state machine и квантайзер: статусы stopped/tracking/paused_by_system, partial-логика (drop/too_short), авто-пауза при sleep/display off, попап возобновления — completed 2025-12-16: реализовано и проверено вручную.
  - [x] Зафиксировать таблицу состояний/событий/переходов (Start/Stop, willSleep/didWake, screensDidSleep/screensDidWake, ручной Resume) (2025-12-16) — переходы инкапсулированы в `AppViewModel` (`mac-app/Sources/LTATApp/AppState.swift`) + `handle(systemEvent:)`.
  - [x] Определить модель “сессия/квант” в памяти: timestamps, elapsed, флаги partial/too_short, reason для system pause (2025-12-16) — добавлены `QuantumSummary`, `QuantumEndReason`, `systemPauseReason` (`mac-app/Sources/LTATApp/AppState.swift`).
  - [x] Реализовать Orchestrator: start/stop, единственный активный квант, таймер на `quantumSeconds` (2025-12-16) — квант-таймер + lifecycle в `AppViewModel` (`mac-app/Sources/LTATApp/AppState.swift`).
  - [x] Реализовать partial-логику по конфигу: `<drop` отбросить, `<too_short` пометить, иначе сохранить partial (2025-12-16) — `finalizeQuantumIfNeeded` (`mac-app/Sources/LTATApp/AppState.swift`).
  - [x] Подключить system hooks: sleep/wake и screens sleep/wake → перевод в `pausedBySystem` + фиксация partial кванта (2025-12-16) — `SystemEventMonitor` + pause/resume prompt на wake/unlock (`mac-app/Sources/LTATApp/SystemEventMonitor.swift`, `mac-app/Sources/LTATApp/AppState.swift`).
  - [x] Реализовать UX-попап возобновления: при `pausedBySystem` показывать prompt “Resume?” и обрабатывать Resume/Stop (2025-12-16) — alert в `ContentView` (`mac-app/Sources/LTATApp/ContentView.swift`).
  - [x] Протянуть всё в `AppViewModel`: один источник правды для `status`, reason, и команды Start/Stop/Resume (2025-12-16) — логика сосредоточена в `AppViewModel` (`mac-app/Sources/LTATApp/AppState.swift`).
  - [x] Логирование переходов и квантов (AuditEvent): state transitions, причины паузы, длительности квантов (2025-12-16) — добавлены quantum logs + transition logs (`mac-app/Sources/LTATApp/AppState.swift`).
  - [x] Smoke: вручную проверить Start→(sleep/screens off)→paused→Resume и partial-пороги (2025-12-16) — подтверждено пользователем.
- [x] Реализовать агрегирование активности: сбор counts (keypress/click/scroll/mouse distance), расчет activity_percent по конфигу, idle/low-activity флаги — started 2025-12-16: декомпозиция добавлена; completed 2025-12-16 — live UI + проверка разрешений + smoke подтвержден.
  - [x] Определить модель агрегатов активности на квант (counts + activity_percent + idle/low) (2025-12-16) — `ActivityCounts`/`ActivityAggregate` (`mac-app/Sources/LTATApp/ActivityMonitor.swift`).
  - [x] Реализовать сбор событий (event tap): keypress/click/scroll + mouse distance (2025-12-16) — `ActivityMonitor` через `CGEvent.tapCreate` (`mac-app/Sources/LTATApp/ActivityMonitor.swift`).
  - [x] Реализовать расчет `activity_percent` по конфигу (K_MAX/C_MAX/S_MAX/M_MAX + веса) (2025-12-16) — `computeActivityPercent` (`mac-app/Sources/LTATApp/ActivityMonitor.swift`).
  - [x] Интегрировать в квантайзер: reset на старт кванта, finalize на end, логирование (2025-12-16) — интеграция в `AppViewModel` + quantum logs (`mac-app/Sources/LTATApp/AppState.swift`).
  - [x] UI: показывать live activity (counts + activity_percent + idle/low) во время трекинга, не только в логах (2025-12-16) — добавлена карточка “Активность” в UI + периодическое обновление `lastActivity` в `AppViewModel`.
  - [x] UI: индикатор проблем с Input Monitoring (если event tap не стартует) (2025-12-16) — выводится предупреждение в карточке “Активность”, если `CGEvent.tapCreate` вернул `nil`.
  - [x] Smoke: потыкать ввод, убедиться что counts растут и `activity_percent` меняется (2025-12-16) — completed 2025-12-16: подтверждено пользователем (после запуска правильного билда с выданными разрешениями); CLI-smoke `--smoke-activity` добавлен.
- [x] Реализовать трекинг фокуса и переключений: frontmost app, bundleId→category, счетчики переключений (квант/час/день), флаги focus_mode/anomaly_switching. — completed 2025-12-16: `AppFocusMonitor` + UI/debug + quantum logs.
  - [x] Определить семантику “switch” и окна агрегации (квант/час/день) (2025-12-16) — completed: день = local midnight, час = календарный час (локальный timezone), anomaly = только app switches.
  - [x] Спроектировать `AppFocusMonitor`: источники событий (NSWorkspace activation + polling fallback), модель `FocusSample` (2025-12-16) — `mac-app/Sources/LTATApp/AppFocusMonitor.swift`.
  - [x] Определить агрегацию по квантy: dwell, primary app/category, `switches_count`, app/category switch counts (2025-12-16) — `FocusQuantumAggregate` + dwell-by-bundle + primary app.
  - [x] Определить rolling-агрегации: switches_last_hour, switches_today (2025-12-16) — completed as calendar-hour buckets + per-day (local midnight) counters.
  - [x] Определить флаги: `focus_mode_flag` (streak) и `anomaly_switching_flag` (пороги `switchingPerQuantum`/`switchingPerHour`) (2025-12-16) — computed in `finalizeQuantum`.
  - [x] Интегрировать в lifecycle квантов: start/reset/finalize + логирование агрегатов (2025-12-16) — wiring in `mac-app/Sources/LTATApp/AppState.swift`.
  - [x] Smoke: добавить `--smoke-focus` (или минимальный UI-debug) для проверки на живой системе (2025-12-16) — `--smoke-focus` via `mac-app/Sources/LTATApp/FocusSmokeRunner.swift` + UI card in `mac-app/Sources/LTATApp/ContentView.swift`.
- [x] Реализовать захват скриншотов: все дисплеи, даунскейл до 1280px (конфиг), JPEG/HEIC, сохранение на ФС и метаданные. — completed 2025-12-16: `ScreenshotService` + async wiring + smoke runner.
  - Note 2025-12-16: сохранять по одному файлу на дисплей (не композит); базовая директория хранения — Application Support.
  - [x] Специфицировать layout хранения в Application Support (папки/нейминг: day/session/quantum + displayId + ts + ext) (2025-12-16) — completed 2025-12-16: `.../Application Support/<App>/Screenshots/YYYY-MM-DD/quantum-<start>-<end>/display-<id>.<ext>`.
  - [x] Определить правило выбора `primary_screenshot_id` (например: main display; fallback: первый доступный дисплей) (2025-12-16) — completed 2025-12-16: main display first, else first captured.
  - [x] Список дисплеев: enumerate active displays и уважать `captureAllDisplays` (2025-12-16) — completed 2025-12-16: `CGGetActiveDisplayList` / `CGMainDisplayID`.
  - [x] Захват: получить `CGImage` по каждому дисплею (с корректной обработкой отсутствия Screen Recording permission/черного кадра) (2025-12-16) — completed 2025-12-16: `CGDisplayCreateImage` + error aggregation.
  - [x] Даунскейл: привести каждый кадр к `downscaleWidth` с сохранением aspect ratio (2025-12-16) — completed 2025-12-16: CGContext resize (RGB, high interpolation).
  - [x] Кодирование: сохранить в `jpeg|heic` с `quality` через ImageIO (2025-12-16) — completed 2025-12-16: `CGImageDestination` + `kCGImageDestinationLossyCompressionQuality`.
  - [x] Метаданные: width/height/format/file_size/hash/captured_at + связь с `quantum_id` и (если нужно) `display_id` (2025-12-16) — completed 2025-12-16: `CapturedScreenshot{displayId,width,height,format,fileSize,sha256,capturedAt}`.
  - [x] Интеграция в lifecycle кванта: когда делаем capture (конец кванта/финализация/асинхронно) и что делаем при ошибке (2025-12-16) — completed 2025-12-16: async capture на `finalizeQuantum` (skip `too_short`/dropped), ошибки в лог + `lastScreenshotCapture`.
  - [x] Smoke: минимальная проверка “файлы реально пишутся по дисплеям и читаемы” (2025-12-16) — completed 2025-12-16: `--smoke-screenshots`.
- [ ] Привязать хранилище: запись Session/Quantum/ActivityAggregate/FocusAggregate/ScreenshotMetadata/AuditLog, индексы, очистка по политике хранения (неделя пока без синка).
  - Note 2025-12-16: multi-display скриншоты = несколько `ScreenshotMetadata` на один `quantum_id`; в `Quantum` хранится `primary_screenshot_id` для превью/быстрого поиска.
- [ ] Генерировать HTML-отчет (конец дня + по запросу) с метриками/графиками/таймлайном скринов/аномалиями.
- [ ] Интегрировать AI mock `AIReportAnalyzer` в отчет (логирование payload, мок-ответ).
- [ ] Полировать UX: главный экран Start/Stop + проект/задача, Today view, Report preview, Settings (конфиг/приватность/retention).
  - [ ] UI: добавить таймер текущего кванта, суммарное затреканное время и сводку (2025-12-16).
  - [ ] UI: показывать превью `primary_screenshot` (последний квант; кликабельно открыть файл/папку) (2025-12-16).
  - [x] UI: починить детект разрешений в онбординге (Screen Recording / Input Monitoring) (2025-12-16) — `CGPreflightScreenCaptureAccess` дополнен fallback через `CGDisplayCreateImage`, Input Monitoring проверяется через `IOHIDCheckAccess` (с fallback на event tap).
- [ ] Реализовать sync stub: очередь SyncQueue, упаковка payload кванта (без отправки), удержание скринов/логов до подтверждения.
- [ ] Packaging/QA: подпись/нотаризация, автозапуск helper-а, sanity-тесты квантов, отчетов, хранения/очистки.
- [x] Сгенерировать `README.md` как для публичного репозитория (2025-12-16) — добавлен `README.md` со статусом WIP, описанием и инструкциями сборки/приватности.
- [x] Repo hygiene: игнорировать локальные кэши `mac-app/.home/` и `mac-app/.xdg-config/` (2025-12-16) — добавлено в `.gitignore`, чтобы не тащить `clang/ModuleCache` и swiftpm-ссылки в git.
