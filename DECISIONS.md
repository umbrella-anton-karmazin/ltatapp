# DECISIONS

- 2025-02-28: Нативное Mac-приложение с UI на Swift/SwiftUI и helper через XPC/LaunchAgent для привилегированного захвата. Причина: минимальный footprint, лучший доступ к macOS screen/input API и UX выдачи разрешений. Отклонено: Electron (больший расход ресурсов, трение с разрешениями), Qt (более тяжелый рантайм, менее нативное ощущение).
- 2025-02-28: Локальное хранение в зашифрованном SQLite со ссылками/блобами скриншотов. Причина: offline-first, структурированные запросы для отчетов, проще миграция к серверной синхронизации. Отклонено: плоские файлы (сложные запросы), немедленное требование бэкенда (не в скоупе сейчас).
- 2025-02-28: Конфигурация (JSON/YAML) управляет длительностью квантов, порогами partial-квантов, формулой активности, категориями приложений, порогами аномалий, параметрами скриншотов и retention; значения не хардкодятся. Причина: гибкая настройка без перекомпиляции, быстрая калибровка. Отклонено: захардкоженные константы с пересборкой при изменениях.
- 2025-02-28: AI-анализ отчетов в MVP — локальный mock `AIReportAnalyzer.analyze` с логированием входного payload (без скриншотов), без удаленных вызовов. Причина: оффлайн MVP и требования приватности; реальная интеграция с внешним AI отложена. Отклонено: вызов внешних AI-сервисов сейчас или отсутствие модуля вовсе.
- 2025-02-28: Политика скриншотов/логов — дефолтный даунскейл 1280px по ширине, форматы JPEG/HEIC; хранение до подтвержденного синка с сервером, пока синка нет — удерживать 7 дней. Причина: баланс читаемости и хранения, соответствие будущему серверному флоу. Отклонено: более высокое базовое разрешение без лимитов хранения.
- 2025-02-28: Объем трекинга приложений — учитывать все основные браузеры (включая новые, Comet и др.), основные IDE и офисные пакеты; в MVP не фиксировать вкладки/документы/проекты, только сами приложения (frontmost). Причина: уменьшить сложность/риски приватности, сфокусироваться на базовых метриках. Отклонено: захват вкладок/документов/проектов в MVP.
- 2025-02-28: Редактирование квантов после факта — разрешена смена проекта и задачи. Причина: исправление ошибок ввода и гибкость учета. Отклонено: запрет пост-редактирования.
- 2025-02-28: Аномалии выводятся в отчет, без отдельного оповещения в MVP. Причина: минимизировать шум и сложность в первой версии. Отклонено: пуш/системные уведомления на аномалии сейчас.
- 2025-02-28: Сырые события откладываются; флаг `enableRawEvents` остается выключен в MVP. Причина: снизить объем данных и приватностные риски, сократить сложность. Отклонено: включать сбор сырых событий в MVP.
- 2025-02-28: Дефолты активности и partial-квантов — K_MAX=150, C_MAX=90, S_MAX=120, M_MAX=5000px; веса 0.4/0.25/0.2/0.15; low activity <20%; idle, если нет событий за квант; partial: <30s drop, 30–120s `too_short`, ≥120s обычный partial. Причина: задать стартовые калибровки без хардкода, управляемые конфигом. Отклонено: отсутствие дефолтов или иные пороги без валидации.
- 2025-02-28: Базовый маппинг bundleId → category — перечень популярных браузеров, IDE/код-редакторов, офисных пакетов, мессенджеров, терминалов и design/media-инструментов (см. PLAN.md Update 2025-02-28); остальные — fallback System/Other. Причина: обеспечить готовый конфиг по умолчанию. Отклонено: пустой список или трекинг вкладок/документов в MVP.
- 2025-02-28: Десктопный стек — Swift/SwiftUI + AppKit (по необходимости) с фоновой службой через LaunchAgent/XPC. Причина: нативный доступ к Screen Recording/Input Monitoring/Accessibility, минимальный footprint, предсказуемая подпись/нотаризация, удобный IPC для привилегированного захвата. Отклонено: Electron (большой ресурсный footprint, трение с разрешениями), Qt (более тяжелый рантайм, менее нативный UX), кроссплатформенные фреймворки (MAUI/Flutter) из-за слабой поддержки macOS-привилегий в MVP.
- 2025-02-28: Аудио/камера для активности (речь/видео) — не делаем в MVP. Причина: признано ненужным, снижает приватностные риски и сложность. Отклонено: сбор сигналов микрофона/камеры.
- 2025-12-16: Для MVP используем один бинарь и режим `--helper` для LaunchAgent (вариант A). Причина: минимизировать сложность сборки/упаковки на раннем этапе и быстрее получить автостарт. Отклонено: отдельный helper-executable (вариант B) — оставить на post-MVP, если потребуется разнести entitlements/IPC.
- 2025-12-16: Auto-pause триггерится на lock/unlock в дополнение к sleep/screens sleep; auto-resume не делаем, только prompt на Resume. Причина: на lock экран становится недоступен, а учет времени должен корректно завершать partial-квант и ожидать явного возобновления. Отклонено: игнорировать lock/unlock или делать авто-resume без подтверждения пользователя.
- 2025-12-16: `too_short`-кванты учитываются в “учтенном времени” (сумма `actualDurationSeconds` всех не-dropped квантов), но по умолчанию считаются отдельной категорией для аналитики/отчетов (можно исключать из “основных” метрик активности/фокуса). Причина: не терять фактическое время работы/контекста, но уменьшить шум в метриках при частых коротких остановках/системных паузах. Отклонено: полностью отбрасывать `too_short` (потеря времени) или включать их на равных в аналитике (шум/искажение).
- 2025-12-16: Окно “per day” для счетчиков переключений — с local midnight (по локальному часовому поясу), а не от начала сессии. Причина: ожидаемая пользователем семантика “за день” для отчетов и сравнимости метрик между днями. Отклонено: считать “день” как время от старта трекинга/сессии (сложнее интерпретация и отчеты).
- 2025-12-16: `anomaly_switching_flag` считается только по app switches (смена `bundleId`); category switches могут считаться отдельно, но не участвуют в anomaly в MVP. Причина: меньше шума и более однозначная интерпретация аномалии; маппинг category — конфигный и может меняться, что делает anomaly по категориям менее стабильной. Отклонено: учитывать category switches вместе с app switches; делать отдельную anomaly по category switches в MVP.
- 2025-12-16: `focus_mode`-streak по `primary_app` сбрасывается, если между квантами попадается `too_short` (partial 30–120s). Причина: `too_short` по умолчанию менее репрезентативны и не должны “склеивать” длинные периоды фокуса в один streak. Отклонено: продолжать streak через `too_short`.
- 2025-12-16: Окно “per hour” для счетчиков переключений — календарный час в локальном часовом поясе (например, 14:00–14:59), а не rolling 60 минут. Причина: более понятная пользователю и удобная для отчетов/сравнения метрика “в час”. Отклонено: rolling 60 минут.
- 2025-12-16: Скриншоты в MVP сохраняются по одному файлу на дисплей и складываются в Application Support (внутри папки приложения). Причина: проще обрабатывать multi-display и отлаживать/просматривать артефакты без композитинга; соответствует “локальные артефакты” модели. Отклонено: один композитный скрин на квант; хранение в произвольном пользовательском пути по умолчанию.
- 2025-12-16: В `Quantum` храним `primary_screenshot_id` как быстрый указатель на “preview/primary” скриншот при multi-display (несколько `ScreenshotMetadata` на один `quantum_id`). Причина: ускоряет выбор превью в UI/отчетах без дополнительных правил выбора и тяжелых запросов. Отклонено: оставлять без поля-указателя (вычислять превью каждый раз); хранить одно поле `screenshot_id` без явной семантики.
